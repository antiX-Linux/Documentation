.\" Automatically generated by Pod::Man 2.27 (Pod::Simple 3.23)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is turned on, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{
.    if \nF \{
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\"
.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
.    \" fudge factors for nroff and troff
.if n \{\
.    ds #H 0
.    ds #V .8m
.    ds #F .3m
.    ds #[ \f1
.    ds #] \fP
.\}
.if t \{\
.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.    ds #V .6m
.    ds #F 0
.    ds #[ \&
.    ds #] \&
.\}
.    \" simple accents for nroff and troff
.if n \{\
.    ds ' \&
.    ds ` \&
.    ds ^ \&
.    ds , \&
.    ds ~ ~
.    ds /
.\}
.if t \{\
.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.\}
.    \" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.    \" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.    \" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.    ds : e
.    ds 8 ss
.    ds o a
.    ds d- d\h'-1'\(ga
.    ds D- D\h'-1'\(hy
.    ds th \o'bp'
.    ds Th \o'LP'
.    ds ae ae
.    ds Ae AE
.\}
.rm #[ #] #H #V #F C
.\" ========================================================================
.\"
.IX Title "MAKE-FSTAB 1"
.TH MAKE-FSTAB 1 "2014-11-13" "Version 2.0.0" "antiX Documentation"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
make\-fstab \- Create and update dynamic fstab entries
.SH "SYNOPSIS"
.IX Header "SYNOPSIS"
Add entries to and remove entries from the \fIfstab\fR file.  Designed
to work in a LiveCD/USB environment where the hardware can be
different on every boot yet still respect any entries that were
manually added to \fIfstab\fR.
.PP
In \fBcreate mode\fR, create a \fI/etc/fstab\fR file from scratch or
supplement an existing fstab, creating entries for hard drives and cdrom, dvd,
and floppy devices while  preserve existing entries, if any.  For each entry
added, create a mountpoint under \fI/media\fR and optionally mount either all hard
drive partitions or just usb drive partitions, or none at all.
.PP
In \fBupdate mode\fR, add or remove one entry (and a \fI/media \fR
mountpoint) based on environment variables that are typically
passed to a udev rule.  Also optionally mount hard drive partitions that are
added.
.SH "OPTIONS"
.IX Header "OPTIONS"
.IP "\-c \-\-create" 8
.IX Item "-c --create"
Force \fBcreate mode\fR regardless of environment variables.
.IP "\-\-delete" 8
.IX Item "--delete"
Delete all of our entries from \fIfstab\fR.  Only works in \fBcreate mode\fR.
.IP "\-d \-\-dirs=[nolabel|uuid|encode]" 8
.IX Item "-d --dirs=[nolabel|uuid|encode]"
Comma separated list of directives that control how we name mountpoints
directories under the \fI/media\fR directory.   The full list of valid
directives is:
.Sp
.Vb 1
\& uuid, nouuid, label, nolabel, encode, noencode
.Ve
.IP "\-D \-\-debug" 8
.IX Item "-D --debug"
Add full environment information in the log file in \fBupdate mode\fR.
.IP "\-f \-\-fstab=<file>" 8
.IX Item "-f --fstab=<file>"
Use <file> as the fstab file.  Default is /etc/fstab for root user and
\&./fstab for non-root users.
.IP "\-h \-\-help" 8
.IX Item "-h --help"
Show simple usage.
.IP "\-l \-\-log\-file=<file>" 8
.IX Item "-l --log-file=<file>"
Use <file> as the log file.  The default is make\-fstab.log.
.IP "\-m \-\-mount=[usb|all]" 8
.IX Item "-m --mount=[usb|all]"
Mount these devices when building fstab in \fBcreate mode\fR.  Perhaps it
would be better to name this \f(CW\*(C`\-\-automount\*(C'\fR but we use this name for
backward compatibility. ??
.IP "\-M \-\-mntpnt=<dir>" 8
.IX Item "-M --mntpnt=<dir>"
The directory under which we create mountpoints.  For root user the
default is \fI/media\fR for non-root users the default is \fI./media\fR.
=item \-n \-\-no\-log
.Sp
Disable logging.
.IP "\-N \-\-no\-uuid" 8
.IX Item "-N --no-uuid"
Normally entries in the \f(CW\*(C`fstab\*(C'\fR file are identified with a \s-1UUID\s0 instead
of the device name.   If this is set then device names are used instead.
For example, an entry starting with something like:
.Sp
.Vb 1
\& UUID=12345678\-abcd\-1234\-abcd\-123456789012
.Ve
.Sp
would instead start with just the name of the device:
.Sp
.Vb 1
\& /dev/sda1
.Ve
.Sp
\&\fINote:\fR The udev rule will need to be modified in order to have this
apply in \fBupdate mode\fR.  This is \fInot\fR the same as the \f(CW\*(C`\-\-dirs=nouuid\*(C'\fR
directive.  If \s-1UUIDS\s0 are not available then we automatically fall back
to using device names in \fIfstab\fR entries.
.IP "\-q \-\-quiet" 8
.IX Item "-q --quiet"
Only print errors and warnings.  Normally a short summary of what is
happening in \fBcreate mode\fR is printed out.
.IP "\-s \-\-swap\-only" 8
.IX Item "-s --swap-only"
Only add swap partitions to fstab in \fBcreate mode\fR.
.IP "\-u \-\-update" 8
.IX Item "-u --update"
Force \fBupdate mode\fR regardless of environment variables.
.IP "\-v \-\-verbose" 8
.IX Item "-v --verbose"
Print more information to the screen in both \fBcreate\fR and \fBupdate\fR
modes.
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
The \fImake-fstab\fR program is designed to create and update an \fIfstab\fR
file on a LiveCD/USB system.  On such a system, unless some service
takes responsibility for mounting block devices, an fstab file must be
created anew each time the system boots.  Even on such a system is it
unconventional to dynamically update fstab when devices get plugged and
unplugged but we have found this is very convenient for the users,
especially on command-line only systems.
.PP
Since we need to create an fstab file at boot time anyway, it was not a
big stretch to add full dynamic updating.
.PP
One of the key features is that any manually created fstab entries take
precedence over entries that are generated automatically.  In the
extreme case where all devices are already in the \fIfstab\fR then
\&\fImake-fstab\fR won't do do anything.
.SS "Create Mode"
.IX Subsection "Create Mode"
We begin by removing all fstab entries that were created by this program.
All such entries are preceded by a \fImarker\fR comment line like:
.PP
.Vb 1
\& # created by make\-fstab /dev/sda1
.Ve
.PP
If there are no remaining entries then we erase fstab and replace
it with header comments designed to work with entries generated by
this program.
.PP
\fIHard Drive Devices\fR
.IX Subsection "Hard Drive Devices"
.PP
We start populating fstab by appending entries preceding each entry line
with a marker line as described above.  We start by using the \fIblkid\fR
program to get a list of all block devices with file systems.  We filter
the list to only include devices with major device number 8 or 3 (hard
drives, as opposed to, say, cdrom drives).  For each device we first
check to see if it is already mounted or was already in fstab as a
manual entry.
.PP
If \f(CW\*(C`\-\-swap\*(C'\fR was given then we only add entries for swap devices
and ignore all others.
.PP
\fICD-ROM Devices\fR
.IX Subsection "CD-ROM Devices"
.PP
Next, if there is no \f(CW\*(C`\-\-swap\*(C'\fR then we include entries for the
following devices, if they exist:
.IP "/dev/cdrom*" 4
.IX Item "/dev/cdrom*"
.PD 0
.IP "/dev/cdrw*" 4
.IX Item "/dev/cdrw*"
.IP "/dev/dvd*" 4
.IX Item "/dev/dvd*"
.IP "/dev/fd[0\-9]*" 4
.IX Item "/dev/fd[0-9]*"
.IP "/dev/floppy*" 4
.IX Item "/dev/floppy*"
.IP "/dev/scd[0\-9]*" 4
.IX Item "/dev/scd[0-9]*"
.IP "/dev/sr[0\-9]*" 4
.IX Item "/dev/sr[0-9]*"
.PD
.PP
This may not be as robust as using the major device number for hard
drives but there is ad hocery involved in processing these names anyway.
A subroutine exists to generate this list of devices somewhat more correctly.
.SS "Update Mode"
.IX Subsection "Update Mode"
In \fBupdate mode\fR, act as a udev-helper using environment
variables to determine what to do.  Usually either add
or remove an fstab entry based on the value of the \fB\s-1ACTION\s0\fR variable.
Since it is convenient to use fixed command line parameters inside a
udev rule, the behavior in \fBupdate mode\fR can be controlled by two
files, \fI/etc/fstab.hotplug\fR and \fI/etc/fstab.automount\fR.
.SS "Mountpoint Creation"
.IX Subsection "Mountpoint Creation"
The names of the \fI/media\fR mountpoint directories are controlled by
directives given in the \f(CW\*(C`\-\-dirs\*(C'\fR command line parameter in both
\&\fBcreate\fR and \fBupdate mode\fRs.  It can be further modified by the
contents of the \fIfstab.hotplug\fR file in \fBudpdate mode\fR only.  The
following directives are valid: \f(CW\*(C`label nolabel uuid nouuid encode
noencode\*(C'\fR.  Directives should be separated by commas. The current
default is \f(CW\*(C`label,nouuid,noencode\*(C'\fR.
.PP
Changes accumulate so if you have \f(CW\*(C`\-\-dirs=uuid\*(C'\fR in the udev
rules file and the \fIfstab.hotplug\fR file contains \f(CW\*(C`nolabel\*(C'\fR, the
final result would be \f(CW\*(C`nolabel,uuid,noencode\*(C'\fR.
.IP "label, nolabel" 4
.IX Item "label, nolabel"
If this is set then use the partition label as the mountpoint if it
exists.  Otherwise fallback to using the \s-1UUID\s0 or the device name.
.IP "uuid, nouuid" 4
.IX Item "uuid, nouuid"
If this is set then use the \s-1UUID\s0 of the device as the mountpoint if no
label exists or if labels are not enabled.  Otherwise fallback to using
the device name (\fBsda1\fR, and so on).
.IP "encode, noencode" 4
.IX Item "encode, noencode"
If this is set then mountpoint names based on labels or UUIDs will
mimic the symlinks under \fI/dev/disk/by\-label\fR and \fI/dev/disk/by\-uuid\fR.
The encoding coverts special characters to their hex values.  Examples
of encoding:
.Sp
.Vb 3
\& newline \-\-> \ex0a
\& space   \-\-> \ex20
\& slash   \-\-> \ex2f
.Ve
.Sp
If this is not set then sequences of one or more special characters are
converted to a single underscore.  There are no special characters in
valid UUIDs.
.PP
\fIName Collisions\fR
.IX Subsection "Name Collisions"
.PP
It is very easy for more than one partition to have the same label.
In rarer cases it is possible for there to be collisions in UUIDs
and (very rarely) device names.  If a collision is detected then
a hyphen and a digit are appended to avoid the collision.  Examples:
.IP "\fIboot\fR" 8
.IX Item "boot"
.PD 0
.IP "\fIboot\-2\fR" 8
.IX Item "boot-2"
.IP "\fIboot\-3\fR" 8
.IX Item "boot-3"
.PD
.PP
The digits can range from 2 through 9.  \fB\f(BI\s-1FIXME\s0\fB\fR: should we use 02
\&\*(-- 99 instead?
.SH "ENVIRONMENT"
.IX Header "ENVIRONMENT"
In \fBupdate mode\fR we act as a udev-helper using the environment
variables:
.IP "\s-1ACTION\s0" 4
.IX Item "ACTION"
.PD 0
.IP "\s-1DEVNAME\s0" 4
.IX Item "DEVNAME"
.IP "\s-1ID_FS_LABEL\s0" 4
.IX Item "ID_FS_LABEL"
.IP "\s-1ID_FS_LABEL_ENC\s0" 4
.IX Item "ID_FS_LABEL_ENC"
.IP "\s-1ID_FS_TYPE\s0" 4
.IX Item "ID_FS_TYPE"
.IP "\s-1ID_FS_UUID\s0" 4
.IX Item "ID_FS_UUID"
.IP "\s-1ID_FS_UUID_ENC\s0" 4
.IX Item "ID_FS_UUID_ENC"
.PD
.PP
In addition, if neither \f(CW\*(C`\-\-create\*(C'\fR nor \f(CW\*(C`\-\-update\*(C'\fR is specified then
we will fall back to using environment variables to determine the mode
to use.  If both \fB\s-1ACTION\s0\fR and \fB\s-1DEVNAME\s0\fR are defined then we will use
\&\fBupdate mode\fR, otherwise we will use \fBcreate mode\fR.
.SH "FILES"
.IX Header "FILES"
It is easy to control the operation of the program in \fBcreate mode\fR by
supplying command line parameters.  But if \fBupdate mode\fR is called from a
udev rule then it is not always convenient to have to rewrite the rule
to add command line parameters in order to change the behavior.  So
there are two control files that are used to control the operation when
in \fBupdate mode\fR.
.IP "/etc/fstab.hotplug" 4
.IX Item "/etc/fstab.hotplug"
The existence of this file turns fstab hotplugging on and off.  If the
file does not exist then we do not do nothing when in \fBupdate mode\fR.
The fstab file is not re-written, mountpoint directories are not created
or deleted, and devices are not mounted.
.Sp
If the file exists then fstab hotplugging is enabled.  When a device is
plugged in and we are called via the udev rule then we will create a new
entry for the device in fstab and create a mountpoint directory for it.
Similarly, we will remove the entry for a device and remove its
mountpoint directory when it is unplugged.
.Sp
The contents of this file can contain the same information as the
\&\f(CW\*(C`\-\-dirs\*(C'\fR command line parameter.  It controls how we name the
mountpoint directories under \fI/media\fR.  This file is read \fIafter\fR the
command line parameter is read so you could use \f(CW\*(C`\-\-dirs\*(C'\fR in the udev
rule to alter the defaults and then have those new defaults over-ridden
by the contents of the \fIfstab.hotplug\fR file.  If hotplugging is
disabled then no automounting will occur  because no new entries are
being added to fstab.
.IP "/etc/fstab.automount" 4
.IX Item "/etc/fstab.automount"
The \fI/etc/fstab.automount\fR control file is used in \fBupdate mode\fR.  If
this file exists then we automatically mount a device whenever we create
a new entry for it and the mountpoint is under the \fI/media\fR directory.
.Sp
In \fBcreate mode\fR this same functionality is provided by the \f(CW\*(C`\-\-mount\*(C'\fR
parameter which can be set to \fBall\fR or \fBusb\fR.  There is no equivalent
to usb-only in \fBupdate mode\fR since it is assumed that if automounting
is enabled then any new disk drive that shows up should be automounted.
.SH "DEBUGGING"
.IX Header "DEBUGGING"
It can be tricky and dangerous to debug a script that overwrites your
\&\fIfstab\fR file.  Most of this script can be debugged when it is run as a
non-root user.  In that case, all input and output files are read and
created in the current working directory.  Mountpoints are created in
the \fI./media/\fR directory.  In addition, when run as non-root user, the
\&\fIblkid\fR command is run with \fIsudo\fR to mimic how that program responds
when it is run by root.  But \fIsudo\fR is not used for writing any files
or doing anything to the system, only to gather information so you
should not be alarmed when it asks for your password.
.PP
In addition, the \f(CW\*(C`\-\-debug\*(C'\fR option causes then entire environment to be
sent to the log file when in \fBupdate mode\fR.  This makes it easy to
verify exactly what inputs the program is getting when it is called as a
udev-helper.
.SH "CAVEATS"
.IX Header "CAVEATS"
We do not handle manual entries that start with \f(CW\*(C`LABEL=xxx\*(C'\fR perfectly.
We will not remove them but it is possible that will add an entry that
refers to the same device.  Since labels are generally non-unique, it
is not a good idea to use them to identify devices inside your fstab.
.PP
There are no special characters in valid UUIDs so the encoded and
non-encoded version of \s-1UUIDS\s0 should be identical.  If they are not
indentical then using \f(CW\*(C`UUID=xxx\*(C'\fR in fstab entries will fail.  If there
is a mismatch then we fall back to using the device name to identify the
device in the first field of \fIfstab\fR.
.SH "COPYRIGHT"
.IX Header "COPYRIGHT"
Copyright 2012 \*(-- 1014
BitJam for antiX <http://antix.freeforums.org/>
